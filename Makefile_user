# ===== User-tweakable defaults =====
COUNTY ?= 17031             # 5-digit county FIPS, zero-padded
YEAR   ?= 2020
MONTH  ?= 09
# Pilot window (override for whole-month runs)
START_DATE ?= $(YEAR)-$(MONTH)-06
END_DATE   ?= $(YEAR)-$(MONTH)-12

# ===== Paths =====
EPA_DIR      := data/raw/epa
HMS_DIR      := data/raw/hms
COUNTIES_DIR := data/raw/counties
EAGLEI_DIR   := data/raw/eaglei
OUT_DIR      := outputs

COUNTIES_SHP := $(COUNTIES_DIR)/cb_2020_us_county_500k.shp

# ===== Helpers =====
define loop_days
d=$$(date -u -d "$(START_DATE)" +%Y-%m-%d); \
end=$$(date -u -d "$(END_DATE)" +%Y-%m-%d); \
while [ "$$d" \<= "$$end" ]; do \
  echo $$d; \
  d=$$(date -u -d "$$d + 1 day" +%Y-%m-%d); \
done
endef

# ===== Phony =====
.PHONY: pilot dirs epa_download counties_download hms_download ingest_pm25 smoke_intersect build_panel clean

pilot: dirs epa_download counties_download hms_download ingest_pm25 smoke_intersect build_panel
	@echo "✔ Pilot panel: $(OUT_DIR)/panel_$(COUNTY)_$(START_DATE)_$(END_DATE).parquet"

dirs:
	mkdir -p $(EPA_DIR) $(HMS_DIR)/$(YEAR)/$(MONTH) $(COUNTIES_DIR) $(EAGLEI_DIR) $(OUT_DIR)

# EPA pre-generated daily PM2.5 (88101) CSVs by year
epa_download: | dirs
	curl -fL -o "$(EPA_DIR)/daily_88101_$(YEAR).zip" "https://aqs.epa.gov/aqsweb/airdata/daily_88101_$(YEAR).zip"
	unzip -o "$(EPA_DIR)/daily_88101_$(YEAR).zip" -d "$(EPA_DIR)"

# National counties (cartographic boundaries, 1:500k) — filter to FIPS inside scripts
counties_download: | dirs
	curl -fL -o "$(COUNTIES_DIR)/cb_2020_us_county_500k.zip" "https://www2.census.gov/geo/tiger/GENZ2020/shp/cb_2020_us_county_500k.zip"
	unzip -o "$(COUNTIES_DIR)/cb_2020_us_county_500k.zip" -d "$(COUNTIES_DIR)"

# HMS daily shapefiles for the requested window
hms_download: | dirs
	@python - <<'PY'
import os, pathlib, sys, datetime, subprocess
hms_root = "data/raw/hms"
start = os.environ.get("START_DATE")
end   = os.environ.get("END_DATE")
if not (start and end):
    sys.exit("START_DATE and END_DATE are required")
d0 = datetime.datetime.fromisoformat(start)
d1 = datetime.datetime.fromisoformat(end)
cur = d0
while cur <= d1:
    y = cur.strftime("%Y"); m = cur.strftime("%m"); d = cur.strftime("%d")
    url = f"https://satepsanone.nesdis.noaa.gov/pub/FIRE/web/HMS/Smoke_Polygons/Shapefile/{y}/{m}/hms_smoke{y}{m}{d}.zip"
    dest_dir = pathlib.Path(hms_root)/y/m
    dest_dir.mkdir(parents=True, exist_ok=True)
    zip_path = dest_dir/f"hms_smoke{y}{m}{d}.zip"
    print("Downloading", url)
    subprocess.run(["curl","-fL","-o",str(zip_path),url], check=False)
    if zip_path.exists() and zip_path.stat().st_size>0:
        subprocess.run(["unzip","-o",str(zip_path),"-d",str(dest_dir)], check=False)
    cur += datetime.timedelta(days=1)
PY


# Build PM2.5 county-day mean for the window
ingest_pm25:
	python scripts/ingest_pm25.py \
	  --county $(COUNTY) \
	  --start $(START_DATE) \
	  --end $(END_DATE) \
	  --epa-dir $(EPA_DIR) \
	  --out "$(OUT_DIR)/pm25_$(COUNTY)_$(START_DATE)_$(END_DATE).parquet"

# Intersect HMS polygons with county to get area shares by density
smoke_intersect:
	python scripts/smoke_intersect.py \
	  --county $(COUNTY) \
	  --start $(START_DATE) \
	  --end $(END_DATE) \
	  --hms-dir $(HMS_DIR) \
	  --counties-shp "$(COUNTIES_SHP)" \
	  --out "$(OUT_DIR)/smoke_$(COUNTY)_$(START_DATE)_$(END_DATE).parquet"

# Build the panel; if an EAGLE-I CSV for YEAR exists, it will be filtered & aggregated
build_panel:
	python scripts/build_panel.py \
	  --county $(COUNTY) \
	  --start $(START_DATE) \
	  --end $(END_DATE) \
	  --pm "$(OUT_DIR)/pm25_$(COUNTY)_$(START_DATE)_$(END_DATE).parquet" \
	  --smoke "$(OUT_DIR)/smoke_$(COUNTY)_$(START_DATE)_$(END_DATE).parquet" \
	  --eaglei-csv "$(EAGLEI_DIR)/eaglei_outages_$(YEAR).csv" \
	  --out "$(OUT_DIR)/panel_$(COUNTY)_$(START_DATE)_$(END_DATE).parquet"

clean:
	rm -f $(OUT_DIR)/*.parquet $(OUT_DIR)/*.csv
